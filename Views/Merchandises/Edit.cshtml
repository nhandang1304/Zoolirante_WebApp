@model Zoolirante_Open_Minded.Models.Merchandise
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = "StockAdjustment";
    var role = HttpContextAccessor.HttpContext?.Session.GetString("Role") ?? "Customer";
}

<style>
    :root {
        --amber: #f0ad4e;
        --amber-300: #f6c26b;
    }

    .edit-wrap {
        background: #f7efd9;
        padding: 16px;
        border-radius: 14px;
    }

    .edit-card {
        background: #fff;
        border: 2px solid var(--amber-300);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }

    .cap-box {
        border: 2px solid var(--amber-300);
        border-radius: 12px;
        padding: 12px 14px;
        background: #fffef6;
    }

    .cap-title {
        font-weight: 700;
        margin-bottom: .35rem;
    }

    .badge-note {
        color: #6c757d;
    }

    .sa-title {
        font-weight: 700;
        color: #c06b00;
    }

    .sa-btn {
        background: var(--amber);
        border: none;
        font-weight: 600;
        border-radius: 10px;
        height: 44px;
    }

    .sa-mono {
        font-variant-numeric: tabular-nums;
    }
</style>

<div class="container mt-3">
    <h1 class="mb-2">Edit</h1>
    <h4 class="mb-3">Merchandise</h4>

    <div class="edit-wrap">
        <div class="edit-card">

            <!-- Main edit form (NO Stock textbox) -->
            <form asp-controller="Merchandises" asp-action="Edit" method="post" class="mb-4">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="ProductId" />
                <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label asp-for="Name" class="form-label">Name</label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="col-12 col-md-6">
                        <label asp-for="Price" class="form-label">Price</label>
                        <input asp-for="Price" class="form-control" />
                        <span asp-validation-for="Price" class="text-danger"></span>
                    </div>

                    <div class="col-12">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="col-12 col-md-8">
                        <label asp-for="ImageUrl" class="form-label">Image URL</label>
                        <input asp-for="ImageUrl" class="form-control" />
                        <span asp-validation-for="ImageUrl" class="text-danger"></span>
                    </div>

                    <div class="col-12 col-md-4">
                        <label asp-for="Category" class="form-label">Category</label>
                        <input asp-for="Category" class="form-control" />
                        <span asp-validation-for="Category" class="text-danger"></span>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <a asp-controller="Merchandises" asp-action="Index" class="ms-2">Back to List</a>
                </div>
            </form>




            <!-- Stock Adjustment sub-form (manager/admin only), inside the big box -->
            @if (role == "Manager" || role == "Admin")
            {
                <div class="mb-2 sa-title">Stock Adjustment</div>
                <div class="text-muted mb-2">Record a reason and adjust Stock on hand (SOH). End SOH updates live.</div>

                <form asp-controller="Merchandises" asp-action="AdjustStock" method="post" class="row g-3 align-items-end">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ProductId" />

                    <div class="col-12 col-md-6">
                        <label class="form-label">Reason for Adjustment</label>
                        <input name="reason" class="form-control" placeholder="e.g., Damaged write-off, Stocktake, Supplier credit" />
                    </div>

                    <div class="col-6 col-md-3">
                        <label class="form-label">Adjust SOH by</label>
                        <div class="input-group">
                            <span class="input-group-text">±</span>
                            <input id="adjustBy" name="adjustBy" type="number" value="0" class="form-control" />
                        </div>
                    </div>

                    <div class="col-6 col-md-3">
                        <label class="form-label">End SOH</label>
                        <div class="form-control sa-mono" id="endSoh" data-current="@Model.Stock">@Model.Stock</div>
                        <div class="text-muted small">Current: <span id="curSoh" class="sa-mono">@Model.Stock</span></div>
                    </div>

                    <div class="col-12 col-md-2">
                        <button type="submit" class="btn sa-btn w-100">Save</button>
                    </div>
                </form>

                <script>
                    (function () {
                      const cur = Number(document.getElementById('endSoh').dataset.current || 0);
                      const input = document.getElementById('adjustBy');
                      const end = document.getElementById('endSoh');
                      const curSoh = document.getElementById('curSoh');
                      function recalc() {
                        const delta = Number(input.value || 0);
                        let v = cur + delta;
                        if (v < 0) v = 0;
                        end.textContent = v;
                        curSoh.textContent = cur;
                      }
                      input.addEventListener('input', recalc);
                      recalc();
                    })();
                </script>
            }
        </div>
    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
